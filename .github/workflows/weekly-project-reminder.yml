name: Weekly Project Reminder
on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥æœ8æ™‚ï¼ˆJSTï¼‰= æ—¥æ›œæ—¥UTC 23æ™‚
    - cron: '0 23 * * 0'
  workflow_dispatch:
    inputs:
      target_projects:
        description: 'Target project codes (comma separated)'
        required: false
        default: 'all'

jobs:
  remind-stale-projects:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Find stale projects
        id: find-stale
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "
          import os
          from datetime import datetime, timedelta
          from github import Github
          
          g = Github(os.environ['GITHUB_TOKEN'])
          user = g.get_user()
          
          stale_projects = []
          sleeping_projects = []
          
          for repo in user.get_repos():
              if repo.name.startswith(('WD', 'TM', 'DN', 'MA', 'AD')):
                  last_update = repo.updated_at
                  days_since_update = (datetime.now() - last_update).days
                  
                  if days_since_update > 30:
                      stale_projects.append(f'{repo.name} ({days_since_update} days)')
                  elif days_since_update > 7:
                      sleeping_projects.append(f'{repo.name} ({days_since_update} days)')
          
          print(f'::set-output name=stale::{','.join(stale_projects)}')
          print(f'::set-output name=sleeping::{','.join(sleeping_projects)}')
          "
          
      - name: Create reminder issue
        if: steps.find-stale.outputs.stale != ''
        uses: actions/github-script@v6
        with:
          script: |
            const staleProjects = '${{ steps.find-stale.outputs.stale }}'.split(',');
            const sleepingProjects = '${{ steps.find-stale.outputs.sleeping }}'.split(',');
            
            const issueBody = `
            ## ğŸ“Š é€±æ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ### ğŸ”´ è¦æ³¨æ„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ30æ—¥ä»¥ä¸Šæ›´æ–°ãªã—ï¼‰
            ${staleProjects.map(p => `- ${p}`).join('\n')}
            
            ### ğŸŸ¡ ã‚¹ãƒªãƒ¼ãƒ—ä¸­ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ7-30æ—¥æ›´æ–°ãªã—ï¼‰
            ${sleepingProjects.map(p => `- ${p}`).join('\n')}
            
            ### ğŸ’¡ 5åˆ†ã§ã§ãã‚‹ã‚¿ã‚¹ã‚¯ææ¡ˆ
            - README.mdã«ç¾åœ¨ã®çŠ¶æ³ã‚’1è¡Œè¿½åŠ 
            - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’Issueã¨ã—ã¦ä½œæˆ
            - é–¢é€£ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
            - å°ã•ãªãƒã‚°ä¿®æ­£ã‚„ã‚¿ã‚¤ãƒä¿®æ­£
            
            ### ğŸ¯ ä»Šé€±ã®ç›®æ¨™
            æœ€ä½1ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å°ã•ãªæ›´æ–°ã‚’åŠ ãˆã¾ã—ã‚‡ã†ï¼
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: 'WD132_project-vitality-system',
              title: `[${new Date().toISOString().slice(0,10)}] é€±æ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼`,
              body: issueBody,
              labels: ['reminder', 'health-check']
            });
            
      - name: Send Discord notification
        if: steps.find-stale.outputs.stale != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python scripts/discord_reminder.py \
            --stale "${{ steps.find-stale.outputs.stale }}" \
            --sleeping "${{ steps.find-stale.outputs.sleeping }}"